---
title: Netty源码分析
lang: zh-CN
---

# Netty

[Netty](https://netty.io/) 是一款异步事件驱动的网络框架，可以用来快速开发高性能协议服务器和客户端。

> 很多通信模块可以使用 Netty 来开发，基于 TCP/UDP ，方便快捷安全的网络编程框架。

## 从 Linux 内核理解 IO 模型

Socket 是内核中存在的一种数据结构。在 linux 中一切皆文件，Socket 也是以一种文件的方式存在，所以在需要操作 Socket 时需要找到其文件描述符进行系统调用。

故而对于在操作系统内核层面来说主要是网络的接收与发送流程，对于使用来说，主要暴露一些系统调用接口，实现包括单个 Socket 的读取和写入操作。以及一些批量操作，包括优化 IO 流程而设计的一下新的底层数据结构，组织 Socket 等。

而一些开销点则是内存数据的拷贝、系统调用切换、硬中断软中断等。

### 流程梳理以及关键概念

数据准备阶段：网络数据包 -> 网卡 -> DMA -> 内存 -> 硬中断软中断 -> 内核 Socket 接收缓冲区。

数据拷贝阶段：内核 Socket 接收缓冲区 -> 内核空间 -> 用户空间。

#### 阻塞与非阻塞

- 阻塞：在`read`系统调用后需要<u>等待</u>**数据准备阶段**、**数据拷贝阶段**完成才返回。
- 非阻塞：在`read`系统调用后<u>不会等待</u>**数据准备阶段**，函数会返回某个状态、<u>等待</u>**数据拷贝阶段**完成后返回。

特点：非阻塞在**第一阶段**不会等待，**第二阶段**都会等待。

#### 同步和异步

二者的主要区别则是发生在**第二阶段**。

- 同步模式在数据准备就绪后，由**用户线程**的**内核态**来执行第二阶段。也就是说应用程序会在第二阶段发生阻塞，直到数据拷贝完成，系统调用返回。
- 异步则是直接由内核执行数据准备阶段和数据拷贝阶段，完成后回调给用户线程，此时用户线程是不被阻塞的。所以异步需要**内核**的完全支持

> [!NOTE]
>
> Windows 中 IOCP 已经支持异步 IO，Linux 在 5.1 版本引入 io_uring 很好的支持了异步 IO

### IO 模型

现在基本涉及到五种 IO 模型

